<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preinstall Command Generator</title>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #9aa6bf;
      --accent: #7c5cff;
      --accent-dark: #5b3ffd;
      --glass: rgba(255,255,255,0.04);
      --success: #16a34a;
      --danger: #ef4444;
      --highlight: #facc15;
      --text: #e6eef8;
      --border: rgba(255,255,255,0.05);
      --shadow: rgba(2,6,23,0.6);
    }

    :root.light-mode {
      --bg: #f5f7fa;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #7c5cff;
      --accent-dark: #6846ff;
      --glass: rgba(0,0,0,0.04);
      --danger: #ef4444;
      --success: #16a34a;
      --highlight: #d97706;
      --text: #1f2937;
      --border: rgba(0,0,0,0.08);
      --shadow: rgba(0,0,0,0.1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      padding: 36px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .wrap {
      max-width: 980px;
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 22px;
    }

    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 8px 30px var(--shadow);
      border: 1px solid var(--border);
      transition: background 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
    }

    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    h1 { font-size: 18px; margin: 0; }
    p.lead { color: var(--muted); margin: 6px 0 0; font-size: 13px; }

    .textarea-wrapper {
      display: flex;
      height: 480px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--glass);
    }

    .line-numbers {
      counter-reset: line;
      text-align: right;
      padding: 14px 10px;
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size: 13px;
      user-select: none;
      background: rgba(255,255,255,0.02);
      border-right: 1px solid rgba(255,255,255,0.05);
      min-width: 40px;
      overflow-y: auto;
    }

    .line-numbers span { display: block; counter-increment: line; line-height: 1.6em; }
    .line-numbers span::before { content: counter(line); display: block; }

    textarea.input {
      flex: 1;
      resize: none;
      padding: 14px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size: 13px;
      line-height: 1.6em;
      overflow-y: auto;
      height: 100%;
    }

    .controls { display: flex; gap: 8px; margin-top: 12px; }
    button.btn {
      background: linear-gradient(180deg, var(--accent), var(--accent-dark));
      border: 0;
      color: white;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s ease;
    }
    button.btn.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-weight: 600;
    }
    button.btn:hover { opacity: .9; }

    .right { display: flex; flex-direction: column; gap: 12px; }
    .output-list { display: flex; flex-direction: column; gap: 8px; max-height: 520px; overflow: auto; padding-right: 6px; }
    .line { display: flex; gap: 8px; align-items: center; background: var(--glass); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.02); }
    .cmd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size: 13px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .line .meta { display: flex; gap: 8px; margin-left: auto; }
    .copy-btn { background: transparent; border: 1px solid var(--border); padding: 6px 9px; border-radius: 8px; cursor: pointer; color: var(--muted); transition: all .3s ease; }
    .copy-btn.highlighted { background: var(--highlight); color: #000; }
    .copy-btn.rotated { transform: rotate(360deg); }
    .help, .status, .footer { font-size: 13px; color: var(--muted); margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <h1>Preinstall command generator</h1>
          <p class="lead">Paste lines like: <code>password group/server</code> — one per line.</p>
        </div>
      </div>

      <div class="textarea-wrapper">
        <div class="line-numbers" id="lineNumbers"></div>
        <textarea class="input" id="input" placeholder="Example:	password group/server"></textarea>
      </div>

      <div class="controls">
        <button class="btn" id="generate">Generate</button>
        <button class="btn ghost" id="clear">Clear</button>
        <button class="btn ghost" id="pasteExample">Paste example</button>
      </div>

      <div class="help">Rules: each non-empty line must contain <strong>password</strong> and <strong>group/server</strong> separated by whitespace.</div>
      <div class="status" id="status"></div>
    </div>

    <div class="right">
      <div class="card">
        <h2 style="margin:0 0 10px 0; font-size:15px">Generated commands</h2>
        <div class="output-list" id="outputList" aria-live="polite"></div>
        <div class="footer">Each line has a copy button. Use "Copy all" to copy everything at once.</div>
      </div>

      <div class="card" style="padding:12px">
        <strong>Notes</strong>
        <ul style="margin-top:8px">
          <li>Passwords containing single quotes will use a double-quoted wrapper automatically.</li>
          <li>Blank lines are ignored.</li>
          <li>This is client-side only — nothing is sent to a server.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Dark/Light mode theme sync
    document.addEventListener("DOMContentLoaded", function () {
      function applyTheme(theme) {
        if (theme === 'light') document.documentElement.classList.add('light-mode');
        else document.documentElement.classList.remove('light-mode');
      }

      function checkParentTheme() {
        try {
          if (window.parent && window.parent !== window) {
            const parentHasLightMode = window.parent.document.body.classList.contains('light-mode');
            applyTheme(parentHasLightMode ? 'light' : 'dark');
            return true;
          }
        } catch(e) {
          const savedTheme = localStorage.getItem('theme') || 'dark';
          applyTheme(savedTheme);
          return false;
        }
      }

      checkParentTheme();

      window.addEventListener('message', (event) => {
        if (event.data && event.data.theme) {
          applyTheme(event.data.theme);
          localStorage.setItem('theme', event.data.theme);
        }
      });

      setInterval(() => { checkParentTheme(); }, 200);
      window.addEventListener('focus', () => checkParentTheme());
      document.addEventListener('visibilitychange', () => { if (!document.hidden) checkParentTheme(); });
      window.addEventListener('mouseenter', () => checkParentTheme());
      window.addEventListener('click', () => checkParentTheme());
    });

    // ================= Original functionality =================
    const inputEl = document.getElementById('input');
    const outList = document.getElementById('outputList');
    const statusEl = document.getElementById('status');
    const lineNumbers = document.getElementById('lineNumbers');
    let lastClicked = null;

    function shellQuote(pw) {
      if (!pw.includes("'")) return `'${pw}'`;
      if (!pw.includes('"')) return `"${pw.replace(/"/g, '\\"')}"`;
      return "'" + pw.replace(/'/g, "'\"'\"'") + "'";
    }

    function parseLines(text) {
      const lines = text.split(/\r?\n/);
      const results = [];
      const errors = [];
      for (let i = 0; i < lines.length; i++) {
        const raw = lines[i].trim();
        if (!raw) continue;
        const m = raw.match(/^(\S+)\s+(\S+\/\S+)$/);
        if (m) {
          const password = m[1];
          const groupServer = m[2];
          const server = groupServer.split('/').pop();
          const pwQuoted = shellQuote(password);
          const cmd = `cd /srv/salt/sls/SETUP/; venv/bin/python preinstall.py ${server} ${pwQuoted}`;
          results.push({ cmd, original: raw });
        } else {
          errors.push({ lineNumber: i + 1, text: raw });
        }
      }
      return { results, errors };
    }

    function renderResults(results) {
      outList.innerHTML = '';
      if (results.length === 0) {
        outList.innerHTML = '<div style="color:var(--muted)">No commands generated.</div>';
        return;
      }
      results.forEach((r) => {
        const div = document.createElement('div');
        div.className = 'line';
        const pre = document.createElement('div');
        pre.className = 'cmd';
        const preInner = document.createElement('pre');
        preInner.textContent = r.cmd;
        pre.appendChild(preInner);
        div.appendChild(pre);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const serverName = r.original.split('/').pop();
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = serverName;
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(r.cmd);
            copyBtn.textContent = 'Copied';
            if (lastClicked && lastClicked !== copyBtn) lastClicked.classList.remove('highlighted','rotated');
            if (lastClicked === copyBtn) copyBtn.classList.add('rotated'); else copyBtn.classList.add('highlighted');
            lastClicked = copyBtn;
            setTimeout(() => copyBtn.textContent = serverName, 1200);
          } catch(e) {
            copyBtn.textContent = 'Failed';
            setTimeout(() => copyBtn.textContent = serverName, 1200);
          }
        });
        meta.appendChild(copyBtn);
        div.appendChild(meta);
        outList.appendChild(div);
      });
    }

    function updateLineNumbers() {
      const lines = inputEl.value.split(/\r?\n/).length;
      lineNumbers.innerHTML = Array.from({length: lines}, () => "<span></span>").join("");
    }

    inputEl.addEventListener("input", updateLineNumbers);
    inputEl.addEventListener("scroll", () => { lineNumbers.scrollTop = inputEl.scrollTop; });
    updateLineNumbers();

    document.getElementById('generate').addEventListener('click', () => {
      const { results, errors } = parseLines(inputEl.value);
      renderResults(results);
      if (errors.length > 0) {
        statusEl.innerHTML = `<span style=color:var(--danger)>Skipped ${errors.length} line(s):</span> ` + errors.map(e => `(line ${e.lineNumber})`).join(' ');
      } else statusEl.textContent = `OK — ${results.length} command(s) generated.`;
    });

    document.getElementById('clear').addEventListener('click', () => {
      inputEl.value = '';
      outList.innerHTML = '';
      statusEl.textContent = '';
      updateLineNumbers();
    });

    document.getElementById('pasteExample').addEventListener('click', () => {
      inputEl.value = 'pass11 \goup1/server1\npass22 \goup2/server2\npass33 \goup3/server3';
      updateLineNumbers();
    });
  </script>
</body>
</html>
