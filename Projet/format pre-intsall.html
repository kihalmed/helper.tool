<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preinstall Command Generator</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa6bf; --accent:#7c5cff; --glass: rgba(255,255,255,0.04);
      --success:#16a34a; --danger:#ef4444; --highlight:#facc15;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg, #021026 0%, #071229 100%); color:#e6eef8; -webkit-font-smoothing:antialiased;
      padding:36px; display:flex; align-items:flex-start; justify-content:center;
    }
    .wrap{max-width:980px; width:100%; display:grid; grid-template-columns:1fr 420px; gap:22px;}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
    .header{display:flex; align-items:center; gap:12px; margin-bottom:12px}
    h1{font-size:18px;margin:0}
    p.lead{color:var(--muted); margin:6px 0 0; font-size:13px}

    textarea.input{width:100%; min-height:300px; resize:vertical; border-radius:10px; padding:14px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; color:#dff0ff; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.03)}

    .controls{display:flex; gap:8px; margin-top:12px}
    button.btn{background:linear-gradient(180deg,var(--accent),#5b3ffd); border:0; color:white; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    button.btn.ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-weight:600}
    button.btn.warn{background:linear-gradient(180deg,#f97316,#ef4444)}

    .right{display:flex; flex-direction:column; gap:12px}
    .output-list{display:flex; flex-direction:column; gap:8px; max-height:520px; overflow:auto; padding-right:6px}
    .line{display:flex; gap:8px; align-items:center; background:var(--glass); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02)}
    .cmd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; color:#e6f7ff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .cmd pre{margin:0; font-family:inherit}
    .line .meta{display:flex; gap:8px; margin-left:auto}
    .copy-btn{background:transparent; border:1px solid rgba(255,255,255,0.06); padding:6px 9px; border-radius:8px; cursor:pointer; color:var(--muted); transition:all .3s ease}

    .copy-btn.highlighted{background:var(--highlight); color:#000;}
    .copy-btn.rotated{transform:rotate(360deg);}

    .help{font-size:13px; color:var(--muted); margin-top:8px}
    .status{font-size:13px; color:var(--muted); margin-top:8px}

    .footer{margin-top:12px; font-size:13px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <h1>Preinstall command generator</h1>
          <p class="lead">Paste lines like: <code>password group/server</code> — one per line. The tool will produce ready-to-copy commands.</p>
        </div>
      </div>

      <textarea class="input" id="input" placeholder="Example:	pdljjyst887 ot01/sv55554"></textarea>

      <div class="controls">
        <button class="btn" id="generate">Generate</button>
        <button class="btn ghost" id="clear">Clear</button>
        <button class="btn ghost" id="pasteExample">Paste example</button>
      </div>

      <div class="help">Rules: each non-empty line must contain <strong>password</strong> and <strong>group/server</strong> separated by whitespace. Lines that don't match will be skipped and shown in status.</div>
      <div class="status" id="status"></div>
    </div>

    <div class="right">
      <div class="card">
        <h2 style="margin:0 0 10px 0; font-size:15px">Generated commands</h2>
        <div class="output-list" id="outputList" aria-live="polite"></div>
        <div class="footer">Each line has a copy button. Use "Copy all" to copy everything at once.</div>
      </div>

      <div class="card" style="padding:12px">
        <strong>Notes</strong>
        <ul style="color:var(--muted); margin-top:8px">
          <li>Passwords containing single quotes will use a double-quoted wrapper automatically.</li>
          <li>Blank lines are ignored.</li>
          <li>This is client-side only — nothing is sent to a server.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const inputEl = document.getElementById('input');
    const outList = document.getElementById('outputList');
    const statusEl = document.getElementById('status');

    let lastClicked = null;

    function shellQuote(pw){
      if(!pw.includes("'")) return `'${pw}'`;
      if(!pw.includes('"')) return `"${pw.replace(/"/g, '\\"')}"`;
      return "'" + pw.replace(/'/g, "'\"'\"'") + "'";
    }

    function parseLines(text){
      const lines = text.split(/\r?\n/);
      const results = [];
      const errors = [];
      for(let i=0;i<lines.length;i++){
        const raw = lines[i].trim();
        if(!raw) continue;
        const m = raw.match(/^(\S+)\s+(\S+\/\S+)$/);
        if(m){
          const password = m[1];
          const groupServer = m[2];
          const server = groupServer.split('/').pop();
          const pwQuoted = shellQuote(password);
          const cmd = `cd /srv/salt/sls/SETUP/; venv/bin/python preinstall.py ${server} ${pwQuoted}`;
          results.push({cmd, original:raw});
        } else {
          errors.push({lineNumber:i+1, text:raw});
        }
      }
      return {results, errors};
    }

    function renderResults(results){
      outList.innerHTML='';
      if(results.length===0){
        outList.innerHTML = '<div style="color:var(--muted)">No commands generated.</div>';
        return;
      }
      results.forEach((r, idx)=>{
        const div = document.createElement('div'); div.className='line';
        const pre = document.createElement('div'); pre.className='cmd';
        const preInner = document.createElement('pre'); preInner.textContent = r.cmd;
        pre.appendChild(preInner);
        div.appendChild(pre);

        const meta = document.createElement('div'); meta.className='meta';
        const copyBtn = document.createElement('button'); copyBtn.className='copy-btn'; copyBtn.textContent='Copy';
        copyBtn.addEventListener('click', async ()=>{
          try{
            await navigator.clipboard.writeText(r.cmd);
            copyBtn.textContent='Copied';

            // Remove previous effects
            if(lastClicked && lastClicked !== copyBtn){
              lastClicked.classList.remove('highlighted','rotated');
            }

            // Apply effects
            if(lastClicked === copyBtn){
              copyBtn.classList.add('rotated');
            } else {
              copyBtn.classList.add('highlighted');
            }

            lastClicked = copyBtn;

            setTimeout(()=>{
              copyBtn.textContent='Copy';
            },1200);
          }catch(e){
            copyBtn.textContent='Failed';
            setTimeout(()=>copyBtn.textContent='Copy',1200);
          }
        });
        meta.appendChild(copyBtn);

        div.appendChild(meta);
        outList.appendChild(div);
      });
    }

    document.getElementById('generate').addEventListener('click', ()=>{
      const {results, errors} = parseLines(inputEl.value);
      renderResults(results);
      if(errors.length>0){
        statusEl.innerHTML = `<span style=color:var(--danger)>Skipped ${errors.length} line(s):</span> ` + errors.map(e=>`(line ${e.lineNumber})`).join(' ');
      } else {
        statusEl.textContent = `OK — ${results.length} command(s) generated.`;
      }
    });

    document.getElementById('clear').addEventListener('click', ()=>{ inputEl.value=''; outList.innerHTML=''; statusEl.textContent=''; });
    document.getElementById('pasteExample').addEventListener('click', ()=>{
      inputEl.value = 'password goups/servers \nexample \npdljjyst887 ot01/vs55554 \npdljjyst887 ot01/vs55554';
    });

    document.getElementById('copyAll').addEventListener('click', async ()=>{
      const cmds = Array.from(outList.querySelectorAll('.cmd pre')).map(p=>p.textContent).filter(Boolean);
      if(cmds.length===0) return;
      const all = cmds.join('\n');
      try{
        await navigator.clipboard.writeText(all);
        const old = document.getElementById('copyAll').textContent;
        document.getElementById('copyAll').textContent = 'Copied';
        setTimeout(()=>document.getElementById('copyAll').textContent = old, 1200);
      }catch(e){
        alert('Copy failed: ' + e);
      }
    });

    inputEl.addEventListener('paste', ()=>setTimeout(()=>document.getElementById('generate').click(),50));
    inputEl.addEventListener('drop', ()=>setTimeout(()=>document.getElementById('generate').click(),50));
  </script>
</body>
</html>
